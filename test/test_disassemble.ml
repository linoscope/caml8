open Stdio
open Base
open Caml8_lib

let%expect_test "Test Fische.ch8" =
  let in_ = In_channel.create "../resources/Fishie.ch8" in
  Disassembler.disassemble ~in_ ~out:Out_channel.stdout;

  [%expect {|
    0x0200 CLS
    0x0202 LD         I, 0x220
    0x0204 LD         V2, 0x8
    0x0206 LD         V0, 0xf8
    0x0208 ADD        V0, 0x8
    0x020a LD         V1, 0x10
    0x020c SNE        V0, 0x20
    0x020e JP         0x20e
    0x0210 DRW        V1, V0, 0x8
    0x0212 ADD        I, V2
    0x0214 ADD        V1, 0x8
    0x0216 SNE        V1, 0x30
    0x0218 JP         0x208
    0x021a JP         0x210
    0x021c DATA       0x0000
    0x021e DATA       0x0000
    0x0220 DATA       0x0000
    0x0222 DATA       0x0000
    0x0224 DATA       0x0018
    0x0226 SE         Vc, 0x3c
    0x0228 DATA       0x0000
    0x022a DATA       0x0000
    0x022c DATA       0x0000
    0x022e DATA       0x0000
    0x0230 DATA       0x0000
    0x0232 DATA       0x0000
    0x0234 DATA       0x0000
    0x0236 DATA       0x0000
    0x0238 DATA       0x0000
    0x023a DATA       0x0000
    0x023c DATA       0x0000
    0x023e DATA       0x0000
    0x0240 SE         Ve, 0x3f
    0x0242 SE         Vf, 0x3b
    0x0244 SE         V9, 0x38
    0x0246 SE         V8, 0x38
    0x0248 DATA       0x0000
    0x024a OR         V0, Vc
    0x024c DATA       0xe7ff
    0x024e ADD        Ve, 0x3c
    0x0250 DATA       0x001f
    0x0252 DATA       0xfff9
    0x0254 RND        V0, 0x80
    0x0256 DATA       0x0303
    0x0258 DATA       0x0080
    0x025a DATA       0xe0f0
    0x025c ADD        V8, 0x38
    0x025e JP         0xc1c
    0x0260 SE         V8, 0x38
    0x0262 SE         V9, 0x3b
    0x0264 SE         Vf, 0x3f
    0x0266 SE         Ve, 0x3c
    0x0268 ADD        V8, 0xfc
    0x026a DATA       0xfecf
    0x026c Xor        V7, V0
    0x026e DATA       0x0100
    0x0270 DATA       0x0000
    0x0272 DATA       0x0000
    0x0274 Xor        V0, Ve
    0x0276 DATA       0xff7f
    0x0278 JP         0xc38
    0x027a SE         V8, 0x70
    0x027c DATA       0xf0e0
    0x027e RND        V0, 0x0
    0x0280 SE         Vc, 0x18
    0x0282 DATA       0x0000
    0x0284 DATA       0x0000
    0x0286 DATA       0x0000
    0x0288 DATA       0x0000
    0x028a DATA       0x0000
    0x028c DATA       0x0000
    0x028e DATA       0x0000
    0x0290 DATA       0x0000
    0x0292 DATA       0x0000
    0x0294 DATA       0x0000
    0x0296 DATA       0x0000
    0x0298 DATA       0x0000
    0x029a DATA       0x0000
    0x029c DATA       0x0000
    0x029e DATA       0x0000 |}]

let%expect_test "Test Fische.ch8" =
  let in_ = In_channel.create "../resources/test_opcode.ch8" in
  Disassembler.disassemble ~in_ ~out:Out_channel.stdout;

  [%expect {|
    0x0200 JP         0x24e
    0x0202 DATA       0xeaac
    0x0204 LD         I, 0xaea
    0x0206 RND        Ve, 0xaa
    0x0208 LD         I, 0xaae
    0x020a DATA       0xe0a0
    0x020c LD         I, 0xe0
    0x020e RND        V0, 0x40
    0x0210 SNE        V0, 0xe0
    0x0212 DATA       0xe020
    0x0214 RND        V0, 0xe0
    0x0216 DATA       0xe060
    0x0218 CALL       0xe0
    0x021a LD         I, 0xe0
    0x021c CALL       0x20
    0x021e LD         V0, 0x40
    0x0220 CALL       0x40
    0x0222 DATA       0xe080
    0x0224 DATA       0xe0e0
    0x0226 DATA       0xe020
    0x0228 CALL       0x20
    0x022a DATA       0xe0e0
    0x022c LD         I, 0xe0
    0x022e DATA       0xe0e0
    0x0230 CALL       0xe0
    0x0232 SNE        V0, 0xa0
    0x0234 DATA       0xe0a0
    0x0236 DATA       0xe0c0
    0x0238 LD         V0, Ve
    0x023a DATA       0xe080
    0x023c RND        V0, 0x80
    0x023e LD         I, 0x40
    0x0240 LD         I, 0xa0
    0x0242 LD         I, 0x202
    0x0244 DRW        Va, Vb, 0x4
    0x0246 RET
    0x0248 LD         I, 0x202
    0x024a DRW        Va, Vb, 0x4
    0x024c JP         0x3dc
    0x024e LD         V8, 0x1
    0x0250 LD         V9, 0x5
    0x0252 LD         Va, 0xa
    0x0254 LD         Vb, 0x1
    0x0256 LD         V5, 0x2a
    0x0258 LD         V6, 0x2b
    0x025a LD         I, 0x216
    0x025c DRW        V8, Vb, 0x4
    0x025e LD         I, 0x23e
    0x0260 DRW        V9, Vb, 0x4
    0x0262 LD         I, 0x202
    0x0264 SE         V6, 0x2b
    0x0266 LD         I, 0x206
    0x0268 DRW        Va, Vb, 0x4
    0x026a LD         Vb, 0x6
    0x026c LD         I, 0x21a
    0x026e DRW        V8, Vb, 0x4
    0x0270 LD         I, 0x23e
    0x0272 DRW        V9, Vb, 0x4
    0x0274 LD         I, 0x206
    0x0276 SNE        V5, 0x2a
    0x0278 LD         I, 0x202
    0x027a DRW        Va, Vb, 0x4
    0x027c LD         Vb, 0xb
    0x027e LD         I, 0x21e
    0x0280 DRW        V8, Vb, 0x4
    0x0282 LD         I, 0x23e
    0x0284 DRW        V9, Vb, 0x4
    0x0286 LD         I, 0x206
    0x0288 SE         V5, V6
    0x028a LD         I, 0x202
    0x028c DRW        Va, Vb, 0x4
    0x028e LD         Vb, 0x10
    0x0290 LD         I, 0x226
    0x0292 DRW        V8, Vb, 0x4
    0x0294 LD         I, 0x23e
    0x0296 DRW        V9, Vb, 0x4
    0x0298 LD         I, 0x206
    0x029a ADD        V6, 0xff
    0x029c SNE        V6, 0x2a
    0x029e LD         I, 0x202
    0x02a0 DRW        Va, Vb, 0x4
    0x02a2 LD         Vb, 0x15
    0x02a4 LD         I, 0x22e
    0x02a6 DRW        V8, Vb, 0x4
    0x02a8 LD         I, 0x23e
    0x02aa DRW        V9, Vb, 0x4
    0x02ac LD         I, 0x206
    0x02ae SNE        V5, V6
    0x02b0 LD         I, 0x202
    0x02b2 DRW        Va, Vb, 0x4
    0x02b4 LD         Vb, 0x1a
    0x02b6 LD         I, 0x232
    0x02b8 DRW        V8, Vb, 0x4
    0x02ba LD         I, 0x23e
    0x02bc DRW        V9, Vb, 0x4
    0x02be CALL       0x242
    0x02c0 LD         V8, 0x17
    0x02c2 LD         V9, 0x1b
    0x02c4 LD         Va, 0x20
    0x02c6 LD         Vb, 0x1
    0x02c8 LD         I, 0x20a
    0x02ca DRW        V8, Vb, 0x4
    0x02cc LD         I, 0x236
    0x02ce DRW        V9, Vb, 0x4
    0x02d0 LD         I, 0x202
    0x02d2 DRW        Va, Vb, 0x4
    0x02d4 LD         Vb, 0x6
    0x02d6 LD         I, 0x22a
    0x02d8 DRW        V8, Vb, 0x4
    0x02da LD         I, 0x20a
    0x02dc DRW        V9, Vb, 0x4
    0x02de LD         I, 0x206
    0x02e0 LD         V7, V5
    0x02e2 SNE        V7, 0x2a
    0x02e4 LD         I, 0x202
    0x02e6 DRW        Va, Vb, 0x4
    0x02e8 LD         Vb, 0xb
    0x02ea LD         I, 0x22a
    0x02ec DRW        V8, Vb, 0x4
    0x02ee LD         I, 0x20e
    0x02f0 DRW        V9, Vb, 0x4
    0x02f2 LD         I, 0x206
    0x02f4 LD         V7, 0x2a
    0x02f6 OR         V7, Vb
    0x02f8 SNE        V7, 0x2b
    0x02fa LD         I, 0x202
    0x02fc DRW        Va, Vb, 0x4
    0x02fe LD         Vb, 0x10
    0x0300 LD         I, 0x22a
    0x0302 DRW        V8, Vb, 0x4
    0x0304 LD         I, 0x212
    0x0306 DRW        V9, Vb, 0x4
    0x0308 LD         I, 0x206
    0x030a LD         V6, 0x78
    0x030c LD         V7, 0x1f
    0x030e AND        V7, V6
    0x0310 SNE        V7, 0x18
    0x0312 LD         I, 0x202
    0x0314 DRW        Va, Vb, 0x4
    0x0316 LD         Vb, 0x15
    0x0318 LD         I, 0x22a
    0x031a DRW        V8, Vb, 0x4
    0x031c LD         I, 0x216
    0x031e DRW        V9, Vb, 0x4
    0x0320 LD         I, 0x206
    0x0322 LD         V6, 0x78
    0x0324 LD         V7, 0x1f
    0x0326 Xor        V7, V6
    0x0328 SNE        V7, 0x67
    0x032a LD         I, 0x202
    0x032c DRW        Va, Vb, 0x4
    0x032e LD         Vb, 0x1a
    0x0330 LD         I, 0x22a
    0x0332 DRW        V8, Vb, 0x4
    0x0334 LD         I, 0x21a
    0x0336 DRW        V9, Vb, 0x4
    0x0338 LD         I, 0x206
    0x033a LD         V6, 0x8c
    0x033c LD         V7, 0x8c
    0x033e ADD        V7, V6
    0x0340 SNE        V7, 0x18
    0x0342 LD         I, 0x202
    0x0344 DRW        Va, Vb, 0x4
    0x0346 LD         V8, 0x2c
    0x0348 LD         V9, 0x30
    0x034a LD         Va, 0x34
    0x034c LD         Vb, 0x1
    0x034e LD         I, 0x22a
    0x0350 DRW        V8, Vb, 0x4
    0x0352 LD         I, 0x21e
    0x0354 DRW        V9, Vb, 0x4
    0x0356 LD         I, 0x206
    0x0358 LD         V6, 0x8c
    0x035a LD         V7, 0x78
    0x035c SUB        V7, V6
    0x035e SNE        V7, 0xec
    0x0360 LD         I, 0x202
    0x0362 DRW        Va, Vb, 0x4
    0x0364 LD         Vb, 0x6
    0x0366 LD         I, 0x22a
    0x0368 DRW        V8, Vb, 0x4
    0x036a LD         I, 0x222
    0x036c DRW        V9, Vb, 0x4
    0x036e LD         I, 0x206
    0x0370 LD         V6, 0xe0
    0x0372 SHL        V6
    0x0374 SNE        V6, 0xc0
    0x0376 LD         I, 0x202
    0x0378 DRW        Va, Vb, 0x4
    0x037a LD         Vb, 0xb
    0x037c LD         I, 0x22a
    0x037e DRW        V8, Vb, 0x4
    0x0380 LD         I, 0x236
    0x0382 DRW        V9, Vb, 0x4
    0x0384 LD         I, 0x206
    0x0386 LD         V6, 0xf
    0x0388 SHR        V6
    0x038a SNE        V6, 0x7
    0x038c LD         I, 0x202
    0x038e DRW        Va, Vb, 0x4
    0x0390 LD         Vb, 0x10
    0x0392 LD         I, 0x23a
    0x0394 DRW        V8, Vb, 0x4
    0x0396 LD         I, 0x21e
    0x0398 DRW        V9, Vb, 0x4
    0x039a LD         I, 0x3e8
    0x039c LD         V0, 0x0
    0x039e LD         V1, 0x30
    0x03a0 REGDUMP    V0~V1
    0x03a2 LD         I, 0x3e9
    0x03a4 REGLOAD    V0~V0
    0x03a6 LD         I, 0x206
    0x03a8 SNE        V0, 0x30
    0x03aa LD         I, 0x202
    0x03ac DRW        Va, Vb, 0x4
    0x03ae LD         Vb, 0x15
    0x03b0 LD         I, 0x23a
    0x03b2 DRW        V8, Vb, 0x4
    0x03b4 LD         I, 0x216
    0x03b6 DRW        V9, Vb, 0x4
    0x03b8 LD         I, 0x3e8
    0x03ba LD         V6, 0x89
    0x03bc BCD        V6
    0x03be REGLOAD    V0~V2
    0x03c0 LD         I, 0x202
    0x03c2 SE         V0, 0x1
    0x03c4 LD         I, 0x206
    0x03c6 SE         V1, 0x3
    0x03c8 LD         I, 0x206
    0x03ca SE         V2, 0x7
    0x03cc LD         I, 0x206
    0x03ce DRW        Va, Vb, 0x4
    0x03d0 LD         Vb, 0x1a
    0x03d2 LD         I, 0x20e
    0x03d4 DRW        V8, Vb, 0x4
    0x03d6 LD         I, 0x23e
    0x03d8 DRW        V9, Vb, 0x4
    0x03da JP         0x248
    0x03dc JP         0x3dc |}]

let%expect_test "Test minimal_game.ch8" =
  let in_ = In_channel.create "../resources/minimal_game.ch8" in
  Disassembler.disassemble ~in_ ~out:Out_channel.stdout;
  [%expect {|
    0x0200 CLS
    0x0202 CALL       0x214
    0x0204 CALL       0x21a
    0x0206 CALL       0x21a
    0x0208 CALL       0x220
    0x020a CALL       0x21a
    0x020c LD         V0, 0x1
    0x020e LD         DT, V0
    0x0210 CALL       0x242
    0x0212 JP         0x206
    0x0214 LD         V3, 0x20
    0x0216 LD         V4, 0x19
    0x0218 RET
    0x021a LD         I, 0x24a
    0x021c DRW        V3, V4, 0x6
    0x021e RET
    0x0220 LD         V0, 0x8
    0x0222 SKP        V0
    0x0224 JP         0x228
    0x0226 ADD        V4, 0x1
    0x0228 LD         V0, 0x2
    0x022a SKP        V0
    0x022c JP         0x230
    0x022e ADD        V4, 0xff
    0x0230 LD         V0, 0x4
    0x0232 SKP        V0
    0x0234 JP         0x238
    0x0236 ADD        V3, 0xff
    0x0238 LD         V0, 0x6
    0x023a SKP        V0
    0x023c JP         0x240
    0x023e ADD        V3, 0x1
    0x0240 RET
    0x0242 LD         V0, DT
    0x0244 SE         V0, 0x0
    0x0246 JP         0x242
    0x0248 RET
    0x024a SE         Vc, 0x18
    0x024c LD         ST, Vf
    0x024e CALL       0x4e7
    0x0250 ADD        Ve, 0xff
    0x0252 DATA       0x99e7
    0x0254 SE         Vc, 0x0 |}]

